{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Patient {{ patient.p_id }}</title>
  <style>
    /* Minimal styling for clarity */
    .row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
    .reports-list { margin-top:16px; }
    .report-link { color: #0b6; text-decoration: none; cursor: pointer; }
    .report-meta { color:#666; margin-left:8px; font-size:0.9em; }
    .modal { position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal-content { width:85%; height:85%; background:white; padding:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2); }
    .close-btn { float:right; cursor:pointer; }
    iframe, img { width:100%; height:100%; border:0; }
    .status-stable { color: green; font-weight: bold; }
    .status-critical { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>{{ patient.name }} ({{ patient.p_id }})</h1>
  <p>Age: {{ patient.age }}</p>
  <p>Status: <span class="{% if patient.status == 'Critical' %}status-critical{% else %}status-stable{% endif %}">{{ patient.status }}</span></p>
  <p>Disease: {{ patient.disease }}</p>
  <p>Upcoming Test: {{ patient.next_test }}</p>
  <p>Doctor's Message: {{ patient.doctor_note }}</p>
  {% if patient.qr_code %}
    <div>
      <img src="{{ patient.qr_code.url }}" alt="QR Code" style="width:120px;height:120px;">
    </div>
  {% endif %}

  <h2>Existing Reports</h2>
  <div class="reports-list">
    {% for r in existing_reports %}
      <div class="report-item">
        <a class="report-link"
           href="{{ r.file.url }}"
           data-url="{{ r.file.url }}"
           data-fname="{{ r.file.name }}">
           {{ r.description|default:r.file.name }}
        </a>
        <span class="report-meta">{{ r.uploaded_at|date:"Y-m-d H:i" }}</span>
      </div>
    {% empty %}
      <div>No reports yet.</div>
    {% endfor %}
  </div>

  <!-- Modal for preview -->
  <div id="preview-modal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <span id="close-modal" class="close-btn">Close âœ–</span>
      <div id="preview-area" style="width:100%; height:100%;"></div>
    </div>
  </div>

  <script>
    // Helper to determine file type by name
    function isPdf(name) {
      return name && name.toLowerCase().endsWith('.pdf');
    }
    function isImage(name) {
      return name && (name.toLowerCase().match(/\.(jpg|jpeg|png|gif|bmp|webp)$/));
    }

    // Preview modal logic
    const modal = document.getElementById('preview-modal');
    const previewArea = document.getElementById('preview-area');
    const closeModal = document.getElementById('close-modal');

    function openPreviewWithURL(url, filename) {
      previewArea.innerHTML = '';
      if (isPdf(filename)) {
        const iframe = document.createElement('iframe');
        iframe.src = url;
        previewArea.appendChild(iframe);
      } else if (isImage(filename)) {
        const img = document.createElement('img');
        img.src = url;
        previewArea.appendChild(img);
      } else {
        // fallback: try iframe
        const iframe = document.createElement('iframe');
        iframe.src = url;
        previewArea.appendChild(iframe);
      }
      modal.style.display = 'flex';
    }

    // Existing reports click -> open modal with file URL
    document.querySelectorAll('.report-link').forEach(function(el){
      el.addEventListener('click', function(e){
        // prevent navigation and open modal preview
        e.preventDefault();
        const url = this.dataset.url;
        const fname = this.dataset.fname || url;
        openPreviewWithURL(url, fname);
      });
    });

    closeModal.addEventListener('click', function() {
      modal.style.display = 'none';
      previewArea.innerHTML = '';
    });
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
        previewArea.innerHTML = '';
      }
    });
  </script>
</body>
</html>
