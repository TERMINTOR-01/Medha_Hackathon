<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #fff;
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .dashboard-header {
            background: #fff;
            border-radius: 0;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 70px;
            margin-bottom: 0;
            width: 100vw;
            max-width: 100vw;
        }
        .dashboard-header .logo {
            font-weight: 700;
            font-size: 1.5em;
            color: #1976d2;
            letter-spacing: 1px;
        }
        .dashboard-nav {
            display: flex;
            gap: 18px;
        }
        .dashboard-nav .nav-link {
            color: #222;
            font-weight: 500;
            padding: 8px 18px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .dashboard-nav .nav-link.active, .dashboard-nav .nav-link:hover {
            background: #1976d2;
            color: #fff;
        }
        .dashboard-header .user {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }
        .dashboard-header .user img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #1976d2;
        }
        .main-content {
            background: #fff;
            border-radius: 0;
            box-shadow: none;
            padding: 40px 32px 24px 32px;
            width: 100vw;
            max-width: 100vw;
            min-height: calc(100vh - 70px);
            margin: 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 28px;
            margin-bottom: 32px;
            width: 100%;
        }
        .stat-card {
            background: #f7fafd;
            border-radius: 18px;
            box-shadow: none;
            padding: 28px 22px 22px 22px;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }
        .stat-title {
            font-size: 1.08em;
            color: #8ca2b3;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #1976d2;
            margin-bottom: 2px;
        }
        .stat-label {
            font-size: 1em;
            color: #555;
            margin-top: 2px;
        }
        .status-stable {
            color: #2196f3 !important;
        }
        .status-critical {
            color: #e53935 !important;
        }
        .info-box-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 18px;
            margin-bottom: 18px;
            width: 100%;
        }
        .info-box {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            border-radius: 12px;
            padding: 18px 18px 14px 18px;
            font-size: 1.07em;
            font-weight: 500;
            background: #e3f2fd;
            color: #1976d2;
            margin-bottom: 0;
            min-height: 70px;
            width: 100%;
        }
        .info-box.yellow {
            background: #fff9e6;
            color: #bfa100;
        }
        .info-box.green {
            background: #e6f7ee;
            color: #1b8e5a;
        }
        .info-box.purple {
            background: #e6eaff;
            color: #5c6bc0;
        }
        .info-box.gray {
            background: #f3f3f3;
            color: #444;
        }
        .info-box .icon {
            font-size: 1.3em;
            margin-top: 2px;
        }
        .info-box .box-content {
            flex: 1;
        }
        .doctor-reviewed-box {
            background: #ededed;
            color: #444;
            border-radius: 12px;
            padding: 16px 18px;
            font-weight: 600;
            margin-top: 8px;
            margin-bottom: 0;
            font-size: 1.05em;
            width: 100%;
        }
        .qr-section {
            text-align: center;
            margin-top: 18px;
        }
        .qr-section img {
            border-radius: 12px;
            border: 2px solid #e3f2fd;
            background: #f7fafd;
            padding: 8px;
        }
        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #222;
            margin-bottom: 12px;
            margin-top: 32px;
        }
        .reports-list {
            margin-top: 10px;
        }
        .report-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f7fafd;
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 8px;
            box-shadow: 0 1px 4px rgba(25,118,210,0.04);
            width: 100%;
        }
        .report-link {
            color: #1976d2;
            font-weight: 500;
            text-decoration: none;
            transition: color 0.2s;
        }
        .report-link:hover {
            color: #0d47a1;
            text-decoration: underline;
        }
        .report-meta {
            color: #888;
            font-size: 0.93em;
        }
        .modal-content {
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(25,118,210,0.18);
        }
        .close-btn {
            font-size: 1.1em;
            color: #1976d2;
            font-weight: 600;
        }
        @media (max-width: 900px) {
            .info-grid, .info-box-row {
                grid-template-columns: 1fr 1fr;
            }
            .main-content, .dashboard-header {
                padding-left: 10px;
                padding-right: 10px;
            }
        }
        @media (max-width: 600px) {
            .dashboard-header, .main-content {
                padding: 0 2vw;
            }
            .info-grid, .info-box-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <span class="logo">üè• NovaNexus Labs</span>
        <nav class="dashboard-nav">
            <a class="nav-link active" href="#">Dashboard</a>
        </nav>
        <div class="user">
            <span>{{ patient.name|default:"User" }}</span>
            <img src="https://ui-avatars.com/api/?name={{ patient.name|default:'User' }}&background=1976d2&color=fff" alt="User"/>
        </div>
    </div>

    <div class="main-content">
        <form method="get" class="mb-4 d-flex justify-content-center gap-2" style="max-width:340px;margin:auto;">
            <select name="lang" class="form-select" style="width:auto;display:inline-block;">
                <option value="en" {% if current_lang == 'en' %}selected{% endif %}>English</option>
                <option value="hi" {% if current_lang == 'hi' %}selected{% endif %}>‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                <option value="mr" {% if current_lang == 'mr' %}selected{% endif %}>‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                <option value="gu" {% if current_lang == 'gu' %}selected{% endif %}>‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
                <option value="ta" {% if current_lang == 'ta' %}selected{% endif %}>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                <option value="te" {% if current_lang == 'te' %}selected{% endif %}>‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                <option value="bn" {% if current_lang == 'bn' %}selected{% endif %}>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                <option value="pa" {% if current_lang == 'pa' %}selected{% endif %}>‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)</option>
                <option value="kn" {% if current_lang == 'kn' %}selected{% endif %}>‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
                <option value="ml" {% if current_lang == 'ml' %}selected{% endif %}>‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)</option>
            </select>
            <button type="submit" class="btn btn-outline-dark">Change Language</button>
        </form>

        <div class="info-grid">
            <div class="stat-card">
                <div class="stat-title">{{ t_name_label }}</div>
                <div class="stat-value">{{ patient.name }}</div>
                <div class="stat-label">ID: {{ patient.p_id }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Age</div>
                <div class="stat-value">{{ patient.age }}</div>
                <div class="stat-label">Diagnosis: {{ patient.diagnosis }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">{{ t_status_label }}</div>
                <div class="stat-value {% if patient.status == 'Critical' %}status-critical{% else %}status-stable{% endif %}">
                    {{ t_status }}
                </div>
                <div class="stat-label">Condition: {{ t_disease }}</div>
            </div>
        </div>

        <div class="info-box-row">
            <div class="info-box" style="background:#e3f2fd;color:#1976d2;">
                <span class="icon">üìÖ</span>
                <div class="box-content">
                    <strong>Upcoming Test:</strong><br>
                    {{ t_next_test }}
                </div>
            </div>
            <div class="info-box yellow">
                <span class="icon">üìù</span>
                <div class="box-content">
                    <strong>Plan of Action:</strong><br>
                    {{ t_plan_of_action }}
                </div>
            </div>
            <div class="info-box" style="background:#e3f2fd;color:#1976d2;">
                <span class="icon">üíä</span>
                <div class="box-content">
                    <strong>Treatment Given:</strong><br>
                    {{ t_treatment_given }}
                </div>
            </div>
        </div>
        <div class="info-box-row">
            <div class="info-box green">
                <span class="icon">üë®‚Äç‚öïÔ∏è</span>
                <div class="box-content">
                    <strong>Doctor's Message:</strong><br>
                    {{ t_note }}
                </div>
            </div>
            <div class="info-box purple">
                <span class="icon">ü©∫</span>
                <div class="box-content">
                    <strong>Procedure Planned:</strong><br>
                    {{ t_procedure_planned }}
                </div>
            </div>
            <div class="info-box gray">
                <span class="icon">üìÜ</span>
                <div class="box-content">
                    <strong>Next Visit Planned:</strong><br>
                    {{ t_next_visit_planned }}
                </div>
            </div>
        </div>
        <div class="doctor-reviewed-box">
            Doctor Reviewed: {{ reviewer_doctor_name|default:"-" }}
        </div>

        {% if patient.qr_code %}
        <div class="qr-section">
            <img src="{{ patient.qr_code.url }}" alt="QR Code" style="width:120px;height:120px;">
            <div class="text-muted mt-2" style="font-size:0.95em;">Scan for quick access</div>
        </div>
        {% endif %}

        <div class="section-title">Existing Reports</div>
        <div class="reports-list">
            {% for r in existing_reports %}
              <div class="report-item">
                <a class="report-link"
                   href="{{ r.file.url }}"
                   data-url="{{ r.file.url }}"
                   data-fname="{{ r.file.name }}">
                   {{ r.description|default:r.file.name }}
                </a>
                <span class="report-meta">{{ r.uploaded_at|date:"Y-m-d H:i" }}</span>
              </div>
            {% empty %}
              <div>No reports yet.</div>
            {% endfor %}
        </div>

        <!-- Modal for preview -->
        <div id="preview-modal" class="modal" role="dialog" aria-hidden="true">
            <div class="modal-content">
              <span id="close-modal" class="close-btn">Close ‚úñ</span>
              <div id="preview-area" style="width:100%; height:100%;"></div>
            </div>
        </div>

        <div class="text-center mt-4 text-muted small">
            <p>
                Updates last refreshed:
                {% if patient %}
                    {{ patient.updated_at|date:"Y-m-d H:i:s" }}
                {% else %}
                    Unknown
                {% endif %}
            </p>
        </div>
    </div>

    <script>
        function isPdf(name) {
          return name && name.toLowerCase().endsWith('.pdf');
        }
        function isImage(name) {
          return name && (name.toLowerCase().match(/\.(jpg|jpeg|png|gif|bmp|webp)$/));
        }

        const modal = document.getElementById('preview-modal');
        const previewArea = document.getElementById('preview-area');
        const closeModal = document.getElementById('close-modal');

        function openPreviewWithURL(url, filename) {
          previewArea.innerHTML = '';
          if (isPdf(filename)) {
            const iframe = document.createElement('iframe');
            iframe.src = url;
            previewArea.appendChild(iframe);
          } else if (isImage(filename)) {
            const img = document.createElement('img');
            img.src = url;
            previewArea.appendChild(img);
          } else {
            const iframe = document.createElement('iframe');
            iframe.src = url;
            previewArea.appendChild(iframe);
          }
          modal.style.display = 'flex';
        }

        document.querySelectorAll('.report-link').forEach(function(el){
          el.addEventListener('click', function(e){
            e.preventDefault();
            const url = this.dataset.url;
            const fname = this.dataset.fname || url;
            openPreviewWithURL(url, fname);
          });
        });

        closeModal.addEventListener('click', function() {
          modal.style.display = 'none';
          previewArea.innerHTML = '';
        });
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.style.display = 'none';
            previewArea.innerHTML = '';
          }
        });
    </script>
</body>
</html>